{% ckan_extends %}


{% block disclaimer %}
{% endblock %}

{% block publish_button %}
{% endblock %}


{% block delete_button %}

  {# Cancel button (link) #}
  {% if form_style == 'edit' %}
    <a class="btn btn-secondary"
       href="{{ h.url_for(dataset_type ~ '.read', id=pkg_dict.name) }}">
      {{ _('Cancel') }}
    </a>
  {% else %}
    <a class="btn btn-secondary"
       href="{{ h.url_for(dataset_type ~ '.search') }}">
      {{ _('Cancel') }}
    </a>
  {% endif %}

  {% if (form_style == 'edit' and h.check_access('package_delete', {'id': pkg_dict.id})) or (form_style == 'new' and 'id' in data and h.user_can_delete_draft_dataset(data.id)) %}
    <a class="btn btn-danger pull-left" href="{% url_for dataset_type ~ '.delete', id=data.id %}" data-module="confirm-action" data-module-content="{{ h.humanize_entity_type('package', dataset_type, 'delete confirmation') or _('Are you sure you want to delete this dataset?') }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
	{% endif %}

{% endblock %}

{% block save_button %}
  <button class="btn btn-primary" type="submit" name="save" value="go-metadata">
    <i class="fa fa-save"></i> {{ _('Save and exit') }}
  </button>

  {% if form_style == 'edit' %}
    {# ── EDIT MODE: use pkg_dict.id (UUID) so the URL survives slug renames ── #}
    {% set first_res = (pkg_dict.resources[0] if pkg_dict.resources and pkg_dict.resources|length > 0 else None) %}
    {% set attachments_target = (
      h.url_for(dataset_type ~ '_resource.edit', id=pkg_dict.id, resource_id=first_res.id)
      if first_res
      else h.url_for(dataset_type ~ '_resource.new', id=pkg_dict.id)
    ) %}

    <button class="btn btn-primary"
            type="submit"
            name="save" value="go-metadata"
            title="{{ _('Saves this then takes you to attachments') }}"
            formaction="{{ h.url_for(dataset_type ~ '.edit', id=pkg_dict.id, return_to=attachments_target) }}">
      <i class="fa fa-paperclip"></i> {{ _('Save & add attachments') }}
    </button>
  {% else %}
    {# ── CREATE MODE: disable _ckan_phase so _form_save_redirect honours return_to ── #}
    {% set resource_return = '/dataset/<NAME>/resource/new' %}
    <button class="btn btn-primary" type="submit" name="save" value="go-metadata"
            title="{{ _('Creates the dataset then takes you to the attachments page') }}"
            formaction="{{ h.url_for(dataset_type ~ '.new', return_to=resource_return) }}"
            onclick="var ph = document.querySelector('input[name=_ckan_phase]'); if(ph) ph.disabled = true;">
      <i class="fa fa-paperclip"></i> {{ _('Save & add attachments') }}
    </button>
  {% endif %}
{% endblock %}
