{# Organization selector with visibility control inside the package form #}

{% set organizations = h.organizations_available('create_dataset') %}
{% set selected_org = data.get('owner_org') or data.get('group_id') %}

<div data-module="org-visibility">
  {# Organization select – visible to the user #}
  <div class="control-group form-group">
    <label for="field-organizations" class="control-label">
      {{ _('Organization') }}
      <span title="This field is required" class="control-required">*</span>
    </label>
    <div class="controls">
      <select id="field-organizations" name="owner_org" class="form-control form-select" required>
        <option value="">{{ _('-- Select an organization --') }}</option>
        {% for organization in organizations %}
          {% set user_capacity = organization.get('capacity', 'member') %}
          <option value="{{ organization.id }}"
                  data-capacity="{{ user_capacity }}"
                  {% if organization.id == selected_org or organization.name == selected_org %}selected="selected"{% endif %}>
            {{ organization.display_name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  {% block package_metadata_fields_visibility %}
  {# Visibility select – options are toggled dynamically by JS based on the
     user's capacity in the selected organization (data-capacity attribute).
     We render both options and let the JS module show/hide appropriately. #}
  <div class="control-group form-group control-medium" id="visibility-control">
    <label for="field-private" class="control-label">{{ _('Visibility') }}</label>
    <div class="controls">
      <select id="field-private" name="private" class="form-control form-select">
        <option value="True" {% if data.private|default('True')|trim == 'True' %}selected="selected"{% endif %}>{{ _('Private') }}</option>
        <option value="False" {% if data.private|default('True')|trim == 'False' %}selected="selected"{% endif %}>{{ _('Public') }}</option>
      </select>
      <small id="visibility-member-hint" style="display:none;">
        {{ _('This dataset will remain private until an editor reviews it and makes it public.') }}
      </small>
    </div>
  </div>
  {% endblock %}
</div>
