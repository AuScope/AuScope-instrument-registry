{# templates/scheming/form_snippets/composite_repeating_pidinst.html #}

{% import 'macros/form.html' as form %}
{% asset 'composite/composite-repeating_js' %}
{% asset 'composite/composite_css' %}

{%- snippet 'scheming/form_snippets/composite_header.html', field=field, inline=field.help_inline -%}

{# Use composite helper exactly like upstream #}
{% set field_dict_list = h.composite_repeating_get_value_dict_list(
  field.field_name,
  field.subfields,
  data,
  field.form_blanks if 'form_blanks' in field else 1
) %}

<div data-module="instrument-relation-module">
<div data-module="composite-repeating" id="composite-repeating-div-{{ field.field_name }}">

  {% for field_dict in field_dict_list %}
    {% set subfields_repeating_label = field.get("subfields_label", "") %}
    {% set index = loop.index %}

    {# ✅ readonly row rule: only IsNewVersionOf record #}
    {% set row_readonly = (field_dict.get('relation_type') == 'IsNewVersionOf') %}

    <div class="composite-control-repeating{% if row_readonly %} is-readonly{% endif %}"
         {% if row_readonly %}data-row-readonly="true"{% endif %}>

      {% for subfield in field.subfields %}
        {% set subfield_form_snippet = subfield.get("form_snippet", "default") %}
        {% set subfield_index = loop.index %}

        {# Layout wrappers – CSS flex order makes type row appear above id fields #}

        {# Wrap the bare related_identifier text input #}
        {% if subfield.field_name == 'related_identifier' %}
          <div class="pidinst-row-id-text">
        {% endif %}

        {# Close id-text wrapper; open identifier_type + name inline row #}
        {% if subfield.field_name == 'related_identifier_type' %}
          </div>{# /pidinst-row-id-text #}
          <div class="pidinst-row-id-details pidinst-inline-row pidinst-inline-row--double">
        {% endif %}

        {# Resource Type + Relation Type inline row – visually first via CSS order #}
        {% if subfield.field_name == 'related_resource_type' %}
          <div class="pidinst-row-types pidinst-inline-row pidinst-inline-row--double">
        {% endif %}


        {% if subfield_form_snippet == "default" %}

          {% set name = field.field_name + '-' + index|string + '-' + subfield.field_name %}
          {% set default_value = subfield.get("default_value", "") %}
          {% set value = field_dict.get(subfield.field_name, default_value) %}

          {% if subfield.help_text %}
            {% set composite_classes = "form-control composite-subfield-with-help" if subfield_index > 1 else "medinput composite-subfield composite-first-subfield" %}
          {% else %}
            {% set composite_classes = "form-control composite-subfield" if subfield_index > 1 else "medinput composite-subfield composite-first-subfield" %}
          {% endif %}

          {# ----- SELECT / CHOICES ----- #}
          {% if subfield.get('choices', false) %}

            {# If you use multiple_checkbox elsewhere, keep original behavior #}
            {% if subfield.get('preset', '') == "multiple_checkbox" %}
              {%- snippet 'scheming/form_snippets/subfield_snippets/composite_multiple_checkbox.html',
                  index=index, subfield=subfield, subfield_index=subfield_index,
                  subfields_repeating_label=subfields_repeating_label, name=name,
                  value=value, errors=errors -%}

            {% else %}

              {# We render select here so we can inject: disabled + data attrs #}
              {% set base_attrs = subfield.form_attrs if 'form_attrs' in subfield else {} %}
              {% set attrs = base_attrs.copy() %}

              {% if subfield.field_name == 'related_resource_type' %}
                {% set _ = attrs.update({'data-pidinst-reltype-driver': '1'}) %}
              {% endif %}
              {% if subfield.field_name == 'relation_type' %}
                {% set _ = attrs.update({'data-pidinst-reltype-target': '1'}) %}
              {% endif %}

              {% if row_readonly %}
                {% set _ = attrs.update({'disabled': 'disabled'}) %}
              {% endif %}

              {%- call form.input_block(
                for='field-' + name,
                label=h.scheming_language_text(subfield.label) + subfields_repeating_label + ' ' + index|string,
                error=(errors.get(name) if errors else None),
                classes=['control-full'],
                control_classes=[],
                extra_html="",
                is_required=h.scheming_field_required(subfield)
              ) -%}

                <select id="{{ id or name }}"
                        name="{{ name }}"
                        class="{{ composite_classes }}"
                        {{ form.attributes(attrs) }}>
                  <option value=""></option>
                  {% for c in subfield.choices %}
                    {% set opt_val = c.value if c is mapping else c %}
                    {% set opt_lab = c.label if c is mapping else c %}
                    <option value="{{ opt_val }}"
                            {% if value == opt_val %}selected="selected"{% endif %}>
                      {{ opt_lab }}
                    </option>
                  {% endfor %}
                </select>

                {% if subfield_index > 1 %}
                  {%- snippet 'scheming/form_snippets/subfield_snippets/composite_help_text.html', field=subfield -%}
                {% endif %}

                {# Disabled fields don’t submit; mirror it #}
                {% if row_readonly %}
                  <input type="hidden" name="{{ name }}" value="{{ value | empty_and_escape }}">
                {% endif %}

              {% endcall %}

            {% endif %}

          {# ----- TEXT/DATE INPUTS ----- #}
          {% else %}
            {% set type = "text" %}
            {% set classes = ['control-full'] %}
            {% set attrs = subfield.form_attrs if 'form_attrs' in subfield else {} %}
            {% set placeholder = subfield.form_placeholder if 'form_placeholder' in subfield else '' %}

            {% if subfield.get("preset", "") == "date" %}
              {% set value = (field_dict.get(subfield.field_name, default_value) or '').split()[0] %}
              {% set type = "date" %}
              {% set classes = [] %}
            {% endif %}

            {# Disable input for readonly IsNewVersionOf row #}
            {% if row_readonly %}
              {% set _ = attrs.update({'disabled': 'disabled'}) %}
            {% endif %}

            {%- call form.input_block(
              for='field-' + name,
              label=h.scheming_language_text(subfield.label) + subfields_repeating_label + ' ' + index|string,
              error=(errors.get(name) if errors else None),
              classes=classes,
              control_classes=[],
              extra_html="",
              is_required=h.scheming_field_required(subfield)
            ) -%}

              <input id="{{ id or name }}"
                     type="{{ type }}"
                     name="{{ name }}"
                     value="{{ value | empty_and_escape }}"
                     placeholder="{{ placeholder }}"
                     {{ form.attributes(attrs) }}
                     class="{{ composite_classes }}" />

              {% if subfield_index > 1 %}
                {%- snippet 'scheming/form_snippets/subfield_snippets/composite_help_text.html', field=subfield -%}
              {% endif %}

              {# Disabled fields don’t submit; mirror it #}
              {% if row_readonly %}
                <input type="hidden" name="{{ name }}" value="{{ value | empty_and_escape }}">
              {% endif %}

            {% endcall %}

          {% endif %}

          {# First-subfield help block (same as upstream) #}
          {% if subfield_index == 1 and subfield.help_text %}
            {%- set markup_text = h.composite_get_markup(subfield.help_text) -%}
            <div class="info-block composite-subfield-info-first">
              <i class="fa fa-info-circle"></i>
              {{ markup_text|safe }}
            </div>
          {% endif %}

        {% else %}
          {# custom subfield snippet #}
          {% if subfield_form_snippet != None %}
            {%- snippet 'scheming/form_snippets/' + subfield_form_snippet,
              field=subfield, subfield_index=index|string, parent=field.field_name,
              data=field_dict -%}
          {% endif %}
        {% endif %}
        {# Close pidinst-row-id-details after identifier_name #}
        {% if subfield.field_name == 'related_identifier_name' %}
          </div>{# /pidinst-row-id-details #}
        {% endif %}

        {# Close pidinst-row-types after relation_type #}
        {% if subfield.field_name == 'relation_type' %}
          </div>{# /pidinst-row-types #}
        {% endif %}
      {% endfor %}

    </div>
  {% endfor %}

</div>
</div>{# close instrument-relation-module wrapper #}

<hr>

<style>
  /* Visual cue for the locked IsNewVersionOf row */
  #composite-repeating-div-related_identifier_obj .composite-control-repeating.is-readonly {
    opacity: 0.85;
  }

  /* Hide the minus/remove button ONLY for the locked IsNewVersionOf row */
  #composite-repeating-div-related_identifier_obj .composite-control-repeating.is-readonly .btn-danger {
    display: none !important;
  }

  /* Put Type + Relation Type inline */
  #composite-repeating-div-related_identifier_obj .pidinst-inline-row {
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  /* CKAN usually wraps each input_block in .control-group */
  #composite-repeating-div-related_identifier_obj .pidinst-inline-row > .control-group,
  #composite-repeating-div-related_identifier_obj .pidinst-inline-row > .form-group {
    flex: 1 1 0;
    min-width: 220px;
  }

  /* triple row: make ID wider */
  #composite-repeating-div-related_identifier_obj .pidinst-inline-row--triple > .control-group:first-child,
  #composite-repeating-div-related_identifier_obj .pidinst-inline-row--triple > .form-group:first-child {
    flex: 2 1 0;
    min-width: 320px;
  }

  /* On narrow screens, stack */
  @media (max-width: 900px) {
    #composite-repeating-div-related_identifier_obj .pidinst-inline-row {
      flex-direction: column;
    }
  }

  /* ── Layout: flex-column so types row appears above the id inputs ── */
  #composite-repeating-div-related_identifier_obj .composite-control-repeating {
    display: flex;
    flex-direction: column;
  }
  /* Remove button / collapse header stays at the very top */
  #composite-repeating-div-related_identifier_obj .composite-control-repeating > .composite-panel-header,
  #composite-repeating-div-related_identifier_obj .composite-control-repeating > .composite-btn {
    order: 0;
  }
  /* Row 1: Resource Type + Relation Type (shown first) */
  #composite-repeating-div-related_identifier_obj .pidinst-row-types {
    order: 1;
    margin-bottom: 4px;
  }
  /* Row 2: Instrument search (injected by JS after types row) */
  #composite-repeating-div-related_identifier_obj .pidinst-instrument-search {
    order: 2;
  }
  /* Row 3: related_identifier bare text input */
  #composite-repeating-div-related_identifier_obj .pidinst-row-id-text {
    order: 3;
  }
  /* Row 4: Identifier Type + Identifier Name */
  #composite-repeating-div-related_identifier_obj .pidinst-row-id-details {
    order: 4;
  }
  /* On narrow screens, stacked flex items are already column; ensure inline rows wrap */

  /* ── Instrument relation search control ── */
  .pidinst-instrument-search {
    margin-top: 8px;
    padding: 12px;
    border: 1px solid #d0e0f0;
    border-radius: 4px;
    background: #f7fafd;
  }
  .pidinst-instrument-search-label {
    font-weight: 600;
    margin-bottom: 4px;
    color: #2a6496;
  }
  .pidinst-instrument-search-help {
    font-size: 0.85em;
    color: #777;
    margin-top: 4px;
  }
  /* Disabled identifier fields visual cue */
  .pidinst-disabled {
    background-color: #eee !important;
    cursor: not-allowed;
  }

</style>

<script>
(function () {
  const MAP = {
    Document: ["IsDescribedBy"],
    Instrument: ["HasPart", "IsPartOf"],
    Metadata: ["HasMetadata", "IsMetadataFor"],
    Dataset: ["Collects"],
    Version: ["IsNewVersionOf"]
  };

  function applyRow(rowEl) {
    // Skip locked IsNewVersionOf row
    if (rowEl.getAttribute("data-row-readonly") === "true") return;

    const typeSel = rowEl.querySelector('[data-pidinst-reltype-driver="1"]');
    const relSel  = rowEl.querySelector('[data-pidinst-reltype-target="1"]');
    if (!typeSel || !relSel) return;

    const typeVal = (typeSel.value || "").trim();
    const allowed = MAP[typeVal] || [];
    const hasType = !!typeVal;

    // When no Type selected: hide/disable all relation options, and clear value
    if (!hasType) {
      Array.from(relSel.options).forEach(opt => {
        if (!opt.value) {
          opt.disabled = false;
          opt.hidden = false;
        } else {
          opt.disabled = true;
          opt.hidden = true;
        }
      });
      relSel.value = "";
      // optional: disable the whole select so it’s obvious
      relSel.disabled = true;
      return;
    }

    // Type selected: enable relation select and filter allowed options
    relSel.disabled = false;

    Array.from(relSel.options).forEach(opt => {
      if (!opt.value) return; // keep blank visible
      const ok = allowed.includes(opt.value);
      opt.disabled = !ok;
      opt.hidden = !ok;
    });

    // Fix invalid selection
    if (relSel.value && !allowed.includes(relSel.value)) {
      relSel.value = allowed[0] || "";
    }
    // Auto-select if only one choice
    if (!relSel.value && allowed.length === 1) {
      relSel.value = allowed[0];
    }
  }

  function applyAll() {
    const root = document.querySelector('#composite-repeating-div-related_identifier_obj');
    if (!root) return;
    root.querySelectorAll('.composite-control-repeating').forEach(applyRow);
  }

  applyAll();

  document.addEventListener('change', (e) => {
    const row = e.target.closest('#composite-repeating-div-related_identifier_obj .composite-control-repeating');
    if (!row) return;
    if (e.target.matches('[data-pidinst-reltype-driver="1"]')) {
      applyRow(row);
    }
  });

  document.addEventListener('click', (e) => {
    if (e.target.closest('#composite-repeating-div-related_identifier_obj .btn')) {
      setTimeout(applyAll, 0);
    }
  });
})();
</script>
